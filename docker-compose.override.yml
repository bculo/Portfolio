version: '3.4'

services:

  trend.mongo:
    container_name: trend.mongo
    volumes:
      - ./data/mongo/trend:/data/db
      - ./ops/mongo/replica.key:/data/replica.key
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/replica.key
        chown 999:999 /data/replica.key
        exec docker-entrypoint.sh $$@
    command: "mongod --bind_ip_all --replSet myreplica --keyFile /data/replica.key --port 27017"
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: trendpassword
      
  trend.redis:
    container_name: trend_redis
    volumes:
      - ./data/redis/data:/data
    ports:
      - "6379:6379"

  identity.database:
    container_name: identity_database
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=pa55w0rd!
    ports:
      - 1433:1433
    volumes:
      - ./data/identity/data:/var/opt/mssql/data
      - ./data/identity/log:/var/opt/mssql/log
      - ./data/identity/secrets:/var/opt/mssql/secrets
    platform: linux/amd64

  sql.server.tools:
    container_name: msql_tools
    depends_on:
      - identity.database
    command: /bin/bash -c 'until /opt/mssql-tools/bin/sqlcmd -S identity.database -U sa -P pa55w0rd! -Q "create database Keycloak"; do sleep 5; done'

  keycloak:
    container_name: keycloak
    ports:
      - 8080:8080
    environment:
      - KC_DB=mssql
      - KC_TRANSACTION_XA_ENABLED=false
      - KC_DB_URL=jdbc:sqlserver://identity.database;databaseName=Keycloak;encrypt=false;trustServerCertificate=false;
      - KC_DB_USERNAME=sa
      - KC_DB_PASSWORD=pa55w0rd!
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    command: ["start-dev"]
    depends_on:
      - identity.database
      - sql.server.tools

  rabbitmq:
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=rabbitmquser
      - RABBITMQ_DEFAULT_PASS=rabbitmqpassword
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - ./data/rabbitmq/data:/var/lib/rabbitmq

  notification.hub.redis:
    container_name: notification.hub.redis
    ports:
      - "6380:6379"
    volumes:
      - ./data/redis-notification/data:/data

  jager:
    container_name: jager
    ports:
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14250:14250"
      - "14268:14268"
      - "14269:14269"
      - "9411:9411"
        
  dynamodb-mailservice-db:
    container_name: dynamodb-mailservice-db
    hostname: localhost
    volumes:
      - dynamodb-mailservice-db-store:/home/dynamodblocal
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal"

  tracker-postgre-db:
    container_name: tracker-postgre-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=florijan
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgre/stock:/var/lib/postgresql/data

  stock-postgre-db:
    container_name: stock-postgre-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=florijan
    ports:
      - "5433:5432"
    volumes:
      - ./data/postgre/stock:/var/lib/postgresql/data

  user-postgre-db:
    container_name: user-postgre-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=florijan
    ports:
      - "5434:5432"
    volumes:
      - ./data/postgre/user:/var/lib/postgresql/data
        
  pgadmin:
    container_name: pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=root@root.com
      - PGADMIN_DEFAULT_PASSWORD=root
    ports:
      - "5050:80"
    volumes:
      - ./data/pg-admin/data:/var/lib/pgadmin
    
    